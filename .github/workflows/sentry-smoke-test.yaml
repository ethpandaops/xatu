name: Sentry Smoke Test

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  sentry-smoke-test:
    timeout-minutes: 20
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
    - name: Build xatu image
      run: |
        docker build -t ethpandaops/xatu:local .
        echo "Xatu image is built."
    - name: Create Kurtosis config file
      run: |
        cat <<EOF > /tmp/network_params.yaml
          participants:
            - el_type: geth
              cl_type: teku
            - el_type: nethermind
              cl_type: prysm
            - el_type: erigon
              cl_type: lighthouse
            - el_type: besu
              cl_type: lighthouse
            - el_type: reth
              cl_type: lodestar
            - el_type: geth
              cl_type: nimbus
              cl_extra_params:
                - --subscribe-all-subnets
          additional_services: []
          network_params:
            genesis_delay: 180
          xatu_sentry_enabled: true
          xatu_sentry_params:
            xatu_server_addr: xatu-server:8080
            xatu_sentry_image: ethpandaops/xatu:local
            beacon_subscriptions:
            - attestation
            - single_attestation
            - block
            - block_gossip
            - chain_reorg
            - finalized_checkpoint
            - head
            - voluntary_exit
            - contribution_and_proof
        <<EOF
    - name: Run Xatu stack
      timeout-minutes: 10
      shell: bash
      run: |
        docker compose up --detach --quiet-pull &
    - name: Setup kurtosis testnet and run assertoor tests
      id: kurtosis-setup
      uses: ethpandaops/kurtosis-assertoor-github-action@5932604b244dbd2ddb811516b516a9094f4d2c2f # v1
      with:
        ethereum_package_args: /tmp/network_params.yaml
        await_assertoor_tests: false
        enclave_name: xatu
    - name: Show all kurtosis containers
      env:
        SERVICES: ${{ steps.kurtosis-setup.outputs.services }}
      run: |
        echo $SERVICES
    - name: Add all xatu-sentry containers to the xatu network
      run: |
        for container in $(docker ps --filter name=xatu-sentry --format "{{.Names}}"); do docker network connect xatu_xatu-net $container; echo $container; docker restart $container; done
    - name: Verify Clickhouse has data from all sentries
      timeout-minutes: 10
      run: |
        echo "Checking Clickhouse for data from all sentries"

        all_sentries=($(kurtosis enclave inspect xatu | grep cl- | grep http | awk '{ print $2 }' | grep -v validator | sed 's/^cl-//'))

        tables=(
            "beacon_api_eth_v1_events_attestation"
            "beacon_api_eth_v1_events_block"
            "beacon_api_eth_v1_events_head"
        )

        pretty_print() {
            local message=$1
            local color=$2
            local no_color='\033[0m'
            local green='\033[0;32m'
            local red='\033[0;31m'
            local bright_red='\033[1;31m'
            local yellow='\033[0;33m'

            if [ "$color" == "green" ]; then
                color=$green
            elif [ "$color" == "red" ]; then
                color=$red
            elif [ "$color" == "bright_red" ]; then
                color=$bright_red
            elif [ "$color" == "yellow" ]; then
                color=$yellow
            else
                color=$no_color
            fi

            echo -e "${color}######################${no_color}"
            echo -e "${color}      $message      ${no_color}"
            echo -e "${color}######################${no_color}"
        }

        print_logs() {
            for container in $(docker ps --filter name=$1 --format "{{.Names}}"); do
                echo "Logs for $container:\n\n"
                docker logs --tail 5 $container
            done
        }

        # Track which sentries have exported at least one event
        declare -A sentry_has_events

        # Wait for each table to have data from at least one sentry
        for table in "${tables[@]}"; do
            pretty_print "Waiting for $table to have data..." "none"
            while true; do
                data_count=$(docker exec xatu-clickhouse-01 clickhouse-client --query "SELECT COUNT(*) FROM default.$table" || true)
                if [[ $data_count -gt 0 ]]; then
                    pretty_print "$table has $data_count entries" "green"
                    break
                else
                    pretty_print "$table has no entries yet, waiting..." "yellow"
                    print_logs xatu-server
                    print_logs vector
                    sleep 5
                fi
            done
        done

        # Check each sentry and record which ones have data in any table
        for sentry in "${all_sentries[@]}"; do
            pretty_print "Checking sentry $sentry..." "none"
            for table in "${tables[@]}"; do
                data_count=$(docker exec xatu-clickhouse-01 clickhouse-client --user=default --query "SELECT COUNT(*) FROM default.$table WHERE meta_client_name = '$sentry'" || true)
                if [[ $data_count -gt 0 ]]; then
                    pretty_print "$sentry has $data_count entries in $table" "green"
                    sentry_has_events[$sentry]=1
                else
                    pretty_print "$sentry has no entries in $table" "yellow"
                fi
            done
        done

        # Now wait for any sentries that don't have events yet
        max_retries=60  # 5 minutes max (60 * 5 seconds)
        retry_count=0

        while true; do
            all_have_events=true
            for sentry in "${all_sentries[@]}"; do
                if [[ -z "${sentry_has_events[$sentry]}" ]]; then
                    all_have_events=false
                    # Check all tables for this sentry
                    for table in "${tables[@]}"; do
                        data_count=$(docker exec xatu-clickhouse-01 clickhouse-client --user=default --query "SELECT COUNT(*) FROM default.$table WHERE meta_client_name = '$sentry'" || true)
                        if [[ $data_count -gt 0 ]]; then
                            pretty_print "$sentry now has $data_count entries in $table" "green"
                            sentry_has_events[$sentry]=1
                            break
                        fi
                    done

                    if [[ -z "${sentry_has_events[$sentry]}" ]]; then
                        pretty_print "$sentry still has no events in any table" "yellow"
                        print_logs $sentry
                    fi
                fi
            done

            if $all_have_events; then
                pretty_print "All sentries have exported events!" "green"
                break
            fi

            retry_count=$((retry_count + 1))
            if [[ $retry_count -ge $max_retries ]]; then
                pretty_print "Timeout waiting for all sentries" "bright_red"
                echo "Sentries without events:"
                for sentry in "${all_sentries[@]}"; do
                    if [[ -z "${sentry_has_events[$sentry]}" ]]; then
                        echo "  - $sentry"
                        print_logs $sentry
                    fi
                done
                exit 1
            fi

            sleep 5
        done

        # Final summary
        pretty_print "Final Summary" "none"
        for table in "${tables[@]}"; do
            echo "=== $table ==="
            for sentry in "${all_sentries[@]}"; do
                data_count=$(docker exec xatu-clickhouse-01 clickhouse-client --user=default --query "SELECT COUNT(*) FROM default.$table WHERE meta_client_name = '$sentry'" || true)
                if [[ $data_count -gt 0 ]]; then
                    echo "  $sentry: $data_count entries"
                else
                    echo "  $sentry: no entries (client may not be synced)"
                fi
            done
        done

    - name: Collect docker logs on failure
      if: failure()
      uses: jwalton/gh-docker-logs@2741064ab9d7af54b0b1ffb6076cf64c16f0220e # v2.2.2
      with:
        dest: './logs'
    - name: Tar logs
      if: failure()
      run: tar cvzf ./logs.tgz ./logs
    - name: Upload logs to GitHub
      if: failure()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: logs.tgz
        path: ./logs.tgz
