name: Sentry Smoke Test

on:
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  sentry-smoke-test:
    timeout-minutes: 25
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
    - name: Build xatu image
      run: |
        docker build -t ethpandaops/xatu:local .
        echo "Xatu image is built."
    - name: Build sentry-logs image
      run: |
        docker build -t ethpandaops/xatu-sentry-logs:local ./sentry-logs
        echo "Sentry-logs image is built."
    - name: Create Kurtosis config file
      run: |
        cat <<EOF > /tmp/network_params.yaml
          participants:
            - el_type: geth
              cl_type: teku
            - el_type: nethermind
              cl_type: prysm
            - el_type: erigon
              cl_type: lighthouse
            - el_type: besu
              cl_type: lighthouse
            - el_type: reth
              cl_type: lodestar
            - el_type: geth
              cl_type: nimbus
              cl_extra_params:
                - --subscribe-all-subnets
          additional_services: []
          network_params:
            genesis_delay: 180
          xatu_sentry_enabled: true
          xatu_sentry_params:
            xatu_server_addr: xatu-server:8080
            xatu_sentry_image: ethpandaops/xatu:local
            beacon_subscriptions:
            - attestation
            - single_attestation
            - block
            - block_gossip
            - chain_reorg
            - finalized_checkpoint
            - head
            - voluntary_exit
            - contribution_and_proof
        <<EOF
    - name: Create sentry-logs directory and log file
      run: |
        mkdir -p deploy/local/docker-compose/sentry-logs/logs
        chmod 777 deploy/local/docker-compose/sentry-logs/logs
        touch deploy/local/docker-compose/sentry-logs/logs/geth.log
        chmod 666 deploy/local/docker-compose/sentry-logs/logs/geth.log
    - name: Run Xatu stack
      timeout-minutes: 10
      run: |
        docker compose up --detach --quiet-pull
        sleep 30
    - name: Setup kurtosis testnet and run assertoor tests
      id: kurtosis-setup
      uses: ethpandaops/kurtosis-assertoor-github-action@5932604b244dbd2ddb811516b516a9094f4d2c2f # v1
      with:
        ethereum_package_args: /tmp/network_params.yaml
        await_assertoor_tests: false
        enclave_name: xatu
    - name: Show all kurtosis containers
      env:
        SERVICES: ${{ steps.kurtosis-setup.outputs.services }}
      run: |
        echo $SERVICES
    - name: Add all xatu-sentry containers to the xatu network
      run: |
        for container in $(docker ps --filter name=xatu-sentry --format "{{.Names}}" | grep -v xatu-sentry-logs); do docker network connect xatu_xatu-net $container; echo $container; docker restart $container; done
    - name: Verify Clickhouse has data from all sentries
      timeout-minutes: 15
      run: |
        echo "Checking Clickhouse for data from all sentries"

        all_sentries=($(kurtosis enclave inspect xatu | grep cl- | grep http | awk '{ print $2 }' | grep -v validator | sed 's/^cl-//'))

        tables=(
            "beacon_api_eth_v1_events_attestation"
            "beacon_api_eth_v1_events_block"
            "beacon_api_eth_v1_events_head"
        )

        pretty_print() {
            local message=$1
            local color=$2
            local no_color='\033[0m'
            local green='\033[0;32m'
            local red='\033[0;31m'
            local bright_red='\033[1;31m'
            local yellow='\033[0;33m'

            if [ "$color" == "green" ]; then
                color=$green
            elif [ "$color" == "red" ]; then
                color=$red
            elif [ "$color" == "bright_red" ]; then
                color=$bright_red
            elif [ "$color" == "yellow" ]; then
                color=$yellow
            else
                color=$no_color
            fi

            echo -e "${color}######################${no_color}"
            echo -e "${color}      $message      ${no_color}"
            echo -e "${color}######################${no_color}"
        }

        print_logs() {
            for container in $(docker ps --filter name=$1 --format "{{.Names}}"); do
                echo "Logs for $container:\n\n"
                docker logs --tail 5 $container
            done
        }

        # Track which sentries have exported at least one event
        declare -A sentry_has_events

        # Wait for each table to exist and have data from at least one sentry
        for table in "${tables[@]}"; do
            pretty_print "Waiting for $table to exist and have data..." "none"
            while true; do
                # First check if table exists
                table_exists=$(docker exec xatu-clickhouse-01 clickhouse-client --query "EXISTS TABLE default.$table" 2>/dev/null || echo "0")
                if [[ "$table_exists" != "1" ]]; then
                    pretty_print "$table does not exist yet, waiting..." "yellow"
                    print_logs xatu-server
                    print_logs vector
                    sleep 5
                    continue
                fi

                data_count=$(docker exec xatu-clickhouse-01 clickhouse-client --query "SELECT COUNT(*) FROM default.$table" 2>/dev/null || echo "0")
                if [[ "$data_count" =~ ^[0-9]+$ ]] && [[ "$data_count" -gt 0 ]]; then
                    pretty_print "$table has $data_count entries" "green"
                    break
                else
                    pretty_print "$table has no entries yet, waiting..." "yellow"
                    print_logs xatu-server
                    print_logs vector
                    sleep 5
                fi
            done
        done

        # Check each sentry and record which ones have data in any table
        for sentry in "${all_sentries[@]}"; do
            pretty_print "Checking sentry $sentry..." "none"
            for table in "${tables[@]}"; do
                data_count=$(docker exec xatu-clickhouse-01 clickhouse-client --user=default --query "SELECT COUNT(*) FROM default.$table WHERE meta_client_name = '$sentry'" 2>/dev/null || echo "0")
                if [[ "$data_count" =~ ^[0-9]+$ ]] && [[ "$data_count" -gt 0 ]]; then
                    pretty_print "$sentry has $data_count entries in $table" "green"
                    sentry_has_events[$sentry]=1
                else
                    pretty_print "$sentry has no entries in $table" "yellow"
                fi
            done
        done

        # Now wait for any sentries that don't have events yet
        max_retries=60  # 5 minutes max (60 * 5 seconds)
        retry_count=0

        while true; do
            all_have_events=true
            for sentry in "${all_sentries[@]}"; do
                if [[ -z "${sentry_has_events[$sentry]}" ]]; then
                    all_have_events=false
                    # Check all tables for this sentry
                    for table in "${tables[@]}"; do
                        data_count=$(docker exec xatu-clickhouse-01 clickhouse-client --user=default --query "SELECT COUNT(*) FROM default.$table WHERE meta_client_name = '$sentry'" 2>/dev/null || echo "0")
                        if [[ "$data_count" =~ ^[0-9]+$ ]] && [[ "$data_count" -gt 0 ]]; then
                            pretty_print "$sentry now has $data_count entries in $table" "green"
                            sentry_has_events[$sentry]=1
                            break
                        fi
                    done

                    if [[ -z "${sentry_has_events[$sentry]}" ]]; then
                        pretty_print "$sentry still has no events in any table" "yellow"
                        print_logs $sentry
                    fi
                fi
            done

            if $all_have_events; then
                pretty_print "All sentries have exported events!" "green"
                break
            fi

            retry_count=$((retry_count + 1))
            if [[ $retry_count -ge $max_retries ]]; then
                pretty_print "Timeout waiting for all sentries" "bright_red"
                echo "Sentries without events:"
                for sentry in "${all_sentries[@]}"; do
                    if [[ -z "${sentry_has_events[$sentry]}" ]]; then
                        echo "  - $sentry"
                        print_logs $sentry
                    fi
                done
                exit 1
            fi

            sleep 5
        done

        # Final summary
        pretty_print "Final Summary" "none"
        for table in "${tables[@]}"; do
            echo "=== $table ==="
            for sentry in "${all_sentries[@]}"; do
                data_count=$(docker exec xatu-clickhouse-01 clickhouse-client --user=default --query "SELECT COUNT(*) FROM default.$table WHERE meta_client_name = '$sentry'" 2>/dev/null || echo "0")
                if [[ "$data_count" =~ ^[0-9]+$ ]] && [[ "$data_count" -gt 0 ]]; then
                    echo "  $sentry: $data_count entries"
                else
                    echo "  $sentry: no entries (client may not be synced)"
                fi
            done
        done

    - name: Verify sentry-logs (execution_block_metrics) pipeline
      timeout-minutes: 3
      run: |
        echo "Testing sentry-logs execution_block_metrics pipeline"

        # Debug: show running containers
        echo "=== Running containers ==="
        docker ps --format "{{.Names}}"

        # Debug: show sentry-logs container logs
        echo "=== sentry-logs container logs ==="
        docker logs xatu-sentry-logs 2>&1 | tail -50 || echo "Container not found or no logs"

        # Debug: show xatu-server logs
        echo "=== xatu-server container logs ==="
        docker logs xatu-server 2>&1 | tail -30 || echo "Container not found or no logs"

        # Inject fake "Slow block" log entries in all supported formats

        # Format 1: Raw JSON (geth format from PR #33655)
        for i in {1..5}; do
          echo '{"level":"warn","msg":"Slow block","block":{"number":'${i}',"hash":"0x'$(printf '%064d' ${i})'","gas_used":15000000,"tx_count":150},"timing":{"execution_ms":45.2,"state_read_ms":12.1,"state_hash_ms":8.3,"commit_ms":5.4,"total_ms":71.0},"throughput":{"mgas_per_sec":211.27},"state_reads":{"accounts":1234,"storage_slots":5678,"code":89,"code_bytes":45000},"state_writes":{"accounts":234,"accounts_deleted":5,"storage_slots":890,"storage_slots_deleted":12,"code":3,"code_bytes":15000},"cache":{"account":{"hits":1000,"misses":234,"hit_rate":81.0},"storage":{"hits":5000,"misses":678,"hit_rate":88.0},"code":{"hits":80,"misses":9,"hit_rate":89.9,"hit_bytes":40000,"miss_bytes":5000}}}' >> deploy/local/docker-compose/sentry-logs/logs/geth.log
        done

        # Format 2: Terminal format (--log.format terminal, geth default)
        for i in {6..10}; do
          echo 'WARN [01-28|12:58:41.123] {"level":"warn","msg":"Slow block","block":{"number":'${i}',"hash":"0x'$(printf '%064d' ${i})'","gas_used":15000000,"tx_count":150},"timing":{"execution_ms":45.2,"state_read_ms":12.1,"state_hash_ms":8.3,"commit_ms":5.4,"total_ms":71.0},"throughput":{"mgas_per_sec":211.27},"state_reads":{"accounts":1234,"storage_slots":5678,"code":89,"code_bytes":45000},"state_writes":{"accounts":234,"accounts_deleted":5,"storage_slots":890,"storage_slots_deleted":12,"code":3,"code_bytes":15000},"cache":{"account":{"hits":1000,"misses":234,"hit_rate":81.0},"storage":{"hits":5000,"misses":678,"hit_rate":88.0},"code":{"hits":80,"misses":9,"hit_rate":89.9,"hit_bytes":40000,"miss_bytes":5000}}}' >> deploy/local/docker-compose/sentry-logs/logs/geth.log
        done

        # Format 3: Logfmt format (--log.format logfmt)
        for i in {11..15}; do
          echo 't=2026-01-28T12:58:41+0000 lvl=warn msg="{\"level\":\"warn\",\"msg\":\"Slow block\",\"block\":{\"number\":'${i}',\"hash\":\"0x'$(printf '%064d' ${i})'\",\"gas_used\":15000000,\"tx_count\":150},\"timing\":{\"execution_ms\":45.2,\"state_read_ms\":12.1,\"state_hash_ms\":8.3,\"commit_ms\":5.4,\"total_ms\":71.0},\"throughput\":{\"mgas_per_sec\":211.27},\"state_reads\":{\"accounts\":1234,\"storage_slots\":5678,\"code\":89,\"code_bytes\":45000},\"state_writes\":{\"accounts\":234,\"accounts_deleted\":5,\"storage_slots\":890,\"storage_slots_deleted\":12,\"code\":3,\"code_bytes\":15000},\"cache\":{\"account\":{\"hits\":1000,\"misses\":234,\"hit_rate\":81.0},\"storage\":{\"hits\":5000,\"misses\":678,\"hit_rate\":88.0},\"code\":{\"hits\":80,\"misses\":9,\"hit_rate\":89.9,\"hit_bytes\":40000,\"miss_bytes\":5000}}}"' >> deploy/local/docker-compose/sentry-logs/logs/geth.log
        done

        echo "Injected 15 test log entries (5 raw JSON, 5 terminal, 5 logfmt)"

        # Debug: show the log file
        echo "=== geth.log contents ==="
        cat deploy/local/docker-compose/sentry-logs/logs/geth.log | head -10

        sleep 10

        # Debug: show sentry-logs logs after injection
        echo "=== sentry-logs logs after injection ==="
        docker logs xatu-sentry-logs 2>&1 | tail -30 || echo "Container not found"

        # Debug: show xatu-server logs after injection
        echo "=== xatu-server logs after injection ==="
        docker logs xatu-server 2>&1 | tail -30 || echo "Container not found"

        # Wait for data to reach ClickHouse
        max_retries=30
        retry_count=0
        while true; do
          data_count=$(docker exec xatu-clickhouse-01 clickhouse-client --query "SELECT COUNT(*) FROM default.execution_block_metrics" 2>/dev/null || echo "0")
          if [[ "$data_count" -ge 15 ]]; then
            echo "SUCCESS: execution_block_metrics has $data_count entries"
            break
          fi
          echo "Waiting for execution_block_metrics data... (current: $data_count, attempt: $((retry_count + 1))/$max_retries)"
          retry_count=$((retry_count + 1))
          if [[ $retry_count -ge $max_retries ]]; then
            echo "FAILED: Timeout waiting for execution_block_metrics data"
            echo "=== Final sentry-logs logs ==="
            docker logs xatu-sentry-logs 2>&1 | tail -100 || echo "Container not found"
            echo "=== Final xatu-server logs ==="
            docker logs xatu-server 2>&1 | tail -50 || echo "Container not found"
            echo "=== Kafka topics ==="
            docker exec xatu-kafka kafka-topics --list --bootstrap-server localhost:9092 2>/dev/null | grep execution || echo "No execution topics"
            exit 1
          fi
          sleep 5
        done

        # Verify data content
        echo "Sample execution_block_metrics data:"
        docker exec xatu-clickhouse-01 clickhouse-client --query "SELECT block_number, total_ms, mgas_per_sec, meta_client_name FROM default.execution_block_metrics LIMIT 5"

    - name: Collect docker logs on failure
      if: failure()
      uses: jwalton/gh-docker-logs@2741064ab9d7af54b0b1ffb6076cf64c16f0220e # v2.2.2
      with:
        dest: './logs'
    - name: Tar logs
      if: failure()
      run: tar cvzf ./logs.tgz ./logs
    - name: Upload logs to GitHub
      if: failure()
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: logs.tgz
        path: ./logs.tgz
