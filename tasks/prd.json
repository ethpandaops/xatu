{
  "project": "Xatu",
  "branchName": "ralph/horizon",
  "description": "Horizon - Head data collection module with multi-beacon node support, HA coordination, and shared derivers",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add HorizonLocation protobuf message",
      "description": "As a developer, I need HorizonLocation protobuf message to store HEAD and FILL slot positions per deriver.",
      "acceptanceCriteria": [
        "Add HorizonLocation message to pkg/proto/xatu/coordinator.proto with head_slot and fill_slot fields",
        "Add HorizonType enum mirroring CannonType for horizon-specific location types",
        "Add network_id field for multi-network support",
        "Run buf generate to regenerate Go code",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "Add Coordinator RPC methods for Horizon locations",
      "description": "As a developer, I need Coordinator RPC methods to get and upsert Horizon locations.",
      "acceptanceCriteria": [
        "Add GetHorizonLocation RPC method to coordinator.proto",
        "Add UpsertHorizonLocation RPC method to coordinator.proto",
        "Implement GetHorizonLocation in pkg/server/service/coordinator/",
        "Implement UpsertHorizonLocation in pkg/server/service/coordinator/",
        "Add persistence for HorizonLocation in coordinator store",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Create pkg/cldata package structure with interfaces",
      "description": "As a developer, I need the shared cldata package structure with core interfaces.",
      "acceptanceCriteria": [
        "Create pkg/cldata/ directory",
        "Create pkg/cldata/deriver/interface.go with Deriver interface (Start, Stop, Name, CannonType, OnEventsDerived, ActivationFork)",
        "Create pkg/cldata/iterator/interface.go with Iterator interface (Next, UpdateLocation)",
        "Create pkg/cldata/context.go with ContextProvider interface (CreateClientMeta, NetworkName, NetworkID, Wallclock)",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Move BeaconBlockDeriver to shared package",
      "description": "As a developer, I want BeaconBlockDeriver in pkg/cldata so both Cannon and Horizon can use it.",
      "acceptanceCriteria": [
        "Copy pkg/cannon/deriver/beacon/eth/v2/beacon_block.go to pkg/cldata/deriver/beacon_block.go",
        "Refactor to accept Iterator and ContextProvider interfaces instead of concrete types",
        "Update pkg/cannon/cannon.go to use shared BeaconBlockDeriver",
        "Cannon continues to work identically (no behavior change)",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-005",
      "title": "Move AttesterSlashingDeriver to shared package",
      "description": "As a developer, I want AttesterSlashingDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v2/attester_slashing.go to pkg/cldata/deriver/attester_slashing.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared AttesterSlashingDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-006",
      "title": "Move ProposerSlashingDeriver to shared package",
      "description": "As a developer, I want ProposerSlashingDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v2/proposer_slashing.go to pkg/cldata/deriver/proposer_slashing.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared ProposerSlashingDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-007",
      "title": "Move DepositDeriver to shared package",
      "description": "As a developer, I want DepositDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v2/deposit.go to pkg/cldata/deriver/deposit.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared DepositDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Move WithdrawalDeriver to shared package",
      "description": "As a developer, I want WithdrawalDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v2/withdrawal.go to pkg/cldata/deriver/withdrawal.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared WithdrawalDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Move VoluntaryExitDeriver to shared package",
      "description": "As a developer, I want VoluntaryExitDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v2/voluntary_exit.go to pkg/cldata/deriver/voluntary_exit.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared VoluntaryExitDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Move BLSToExecutionChangeDeriver to shared package",
      "description": "As a developer, I want BLSToExecutionChangeDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v2/bls_to_execution_change.go to pkg/cldata/deriver/bls_to_execution_change.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared BLSToExecutionChangeDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Move ExecutionTransactionDeriver to shared package",
      "description": "As a developer, I want ExecutionTransactionDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v2/execution_transaction.go to pkg/cldata/deriver/execution_transaction.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared ExecutionTransactionDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-012",
      "title": "Move ElaboratedAttestationDeriver to shared package",
      "description": "As a developer, I want ElaboratedAttestationDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v2/elaborated_attestation.go to pkg/cldata/deriver/elaborated_attestation.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared ElaboratedAttestationDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-013",
      "title": "Move ProposerDutyDeriver to shared package",
      "description": "As a developer, I want ProposerDutyDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v1/proposer_duty.go to pkg/cldata/deriver/proposer_duty.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared ProposerDutyDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Move BeaconBlobDeriver to shared package",
      "description": "As a developer, I want BeaconBlobDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v1/beacon_blob.go to pkg/cldata/deriver/beacon_blob.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared BeaconBlobDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Move BeaconValidatorsDeriver to shared package",
      "description": "As a developer, I want BeaconValidatorsDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v1/beacon_validators.go to pkg/cldata/deriver/beacon_validators.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared BeaconValidatorsDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Move BeaconCommitteeDeriver to shared package",
      "description": "As a developer, I want BeaconCommitteeDeriver in pkg/cldata.",
      "acceptanceCriteria": [
        "Move pkg/cannon/deriver/beacon/eth/v1/beacon_committee.go to pkg/cldata/deriver/beacon_committee.go",
        "Refactor to use Iterator and ContextProvider interfaces",
        "Update Cannon to use shared BeaconCommitteeDeriver",
        "Cannon continues to work identically",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-017",
      "title": "Clean up old Cannon deriver directory",
      "description": "As a developer, I want to remove the old cannon deriver files now that they're in pkg/cldata.",
      "acceptanceCriteria": [
        "Remove pkg/cannon/deriver/beacon/eth/v1/ directory (files moved to cldata)",
        "Remove pkg/cannon/deriver/beacon/eth/v2/ directory (files moved to cldata)",
        "Update pkg/cannon/deriver/event_deriver.go interface to reference cldata types",
        "Cannon still compiles and works correctly",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-018",
      "title": "Create Horizon module skeleton and CLI command",
      "description": "As an operator, I want to run Xatu in 'horizon' mode.",
      "acceptanceCriteria": [
        "Create pkg/horizon/ directory structure mirroring Cannon",
        "Create pkg/horizon/horizon.go with Horizon struct and New/Start/Stop methods",
        "Create pkg/horizon/config.go with configuration struct",
        "Add cmd/horizon.go with 'xatu horizon' CLI subcommand",
        "Module logs startup message with version and instance ID",
        "Graceful shutdown on SIGTERM/SIGINT",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-019",
      "title": "Add Horizon metrics server",
      "description": "As an operator, I want Horizon to expose Prometheus metrics.",
      "acceptanceCriteria": [
        "Create pkg/horizon/metrics.go with Horizon-specific metrics",
        "Add metrics for head_slot, fill_slot, lag_slots gauges",
        "Add metrics for blocks_derived_total counter",
        "Start metrics server on configured metricsAddr",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-020",
      "title": "Add multi-beacon node connection management",
      "description": "As an operator, I want Horizon to connect to multiple beacon nodes.",
      "acceptanceCriteria": [
        "Create pkg/horizon/ethereum/beacon.go with BeaconNodePool struct",
        "Configuration accepts array of beacon node URLs with optional headers",
        "Each beacon node connection established independently using ethpandaops/beacon library",
        "Health checking per beacon node with configurable interval",
        "Metrics track connection status per beacon node (xatu_horizon_beacon_node_status)",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-021",
      "title": "Add beacon node failover and retry logic",
      "description": "As an operator, I want failed beacon node connections to retry with backoff.",
      "acceptanceCriteria": [
        "Failed connections are retried with exponential backoff",
        "At least one healthy beacon node required to operate (error if all unhealthy)",
        "GetHealthyNode() method returns any healthy node",
        "PreferNode(nodeURL) method prefers specific node but falls back to healthy",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Add SSE event subscription for head blocks",
      "description": "As a data collector, I want Horizon to subscribe to beacon node block events.",
      "acceptanceCriteria": [
        "Create pkg/horizon/subscription/block.go for SSE subscription",
        "Subscribe to /eth/v1/events?topics=block SSE stream on each beacon node",
        "Handle SSE reconnection on connection loss with backoff",
        "Parse block event payload (slot, block root, execution_optimistic flag)",
        "Emit parsed events to channel for processing",
        "Metrics track events received per beacon node (xatu_horizon_sse_events_total)",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Add local deduplication cache",
      "description": "As a data collector, I want Horizon to deduplicate block events by block root.",
      "acceptanceCriteria": [
        "Create pkg/horizon/cache/dedup.go with DedupCache struct",
        "TTL-based cache keyed by block root (configurable TTL, default 13 minutes)",
        "Check(blockRoot) returns true if seen, false if new",
        "First block event for a root triggers derivation, subsequent dropped",
        "Metrics track cache hits/misses (xatu_horizon_dedup_hits_total, xatu_horizon_dedup_cache_size)",
        "Typecheck passes"
      ],
      "priority": 23,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Add Horizon coordinator client",
      "description": "As a developer, I need Horizon to communicate with the Coordinator for location tracking.",
      "acceptanceCriteria": [
        "Create pkg/horizon/coordinator/client.go similar to Cannon's",
        "Implement GetHorizonLocation method",
        "Implement UpsertHorizonLocation method",
        "Support TLS and auth headers from config",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-025",
      "title": "Create HEAD iterator",
      "description": "As a data collector, I want a HEAD iterator for real-time slot processing.",
      "acceptanceCriteria": [
        "Create pkg/horizon/iterator/head.go with HeadIterator struct",
        "Receives slot notifications from SSE deduplication layer via channel",
        "Fetches full block data for the slot from beacon node pool",
        "Implements Iterator interface from pkg/cldata/iterator",
        "UpdateLocation updates coordinator head_slot position",
        "Skips slots already processed (checks coordinator)",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-026",
      "title": "Create FILL iterator",
      "description": "As an operator, I want a FILL iterator for consistency catch-up.",
      "acceptanceCriteria": [
        "Create pkg/horizon/iterator/fill.go with FillIterator struct",
        "Walks slots from fill_slot position toward HEAD - LAG",
        "Configurable LAG distance (default: 32 slots)",
        "Configurable bounded range (maxBoundedSlots, default 7200)",
        "Rate limiting to avoid overwhelming beacon nodes",
        "Implements Iterator interface from pkg/cldata/iterator",
        "UpdateLocation updates coordinator fill_slot position",
        "Typecheck passes"
      ],
      "priority": 26,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-027",
      "title": "Add dual-iterator coordination",
      "description": "As an operator, I want HEAD and FILL iterators to coordinate without blocking each other.",
      "acceptanceCriteria": [
        "HEAD iterator has priority - runs in dedicated goroutine",
        "FILL iterator runs in separate goroutine, never blocks HEAD",
        "Separate location markers in coordinator: head_slot and fill_slot",
        "On startup, HEAD iterator immediately begins tracking new blocks",
        "On startup, FILL iterator begins from fill_slot toward HEAD - LAG",
        "Both iterators skip slots marked as processed by the other",
        "Typecheck passes"
      ],
      "priority": 27,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-028",
      "title": "Wire block-based derivers to Horizon",
      "description": "As a developer, I want Horizon to use shared block derivers.",
      "acceptanceCriteria": [
        "Instantiate BeaconBlockDeriver with Horizon's HEAD iterator",
        "Instantiate AttesterSlashingDeriver, ProposerSlashingDeriver",
        "Instantiate DepositDeriver, WithdrawalDeriver, VoluntaryExitDeriver",
        "Instantiate BLSToExecutionChangeDeriver, ExecutionTransactionDeriver",
        "Instantiate ElaboratedAttestationDeriver",
        "All derivers use Horizon's ContextProvider for MODULE_NAME: HORIZON",
        "Events emitted to configured sinks",
        "Typecheck passes"
      ],
      "priority": 28,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-029",
      "title": "Wire epoch-based derivers to Horizon",
      "description": "As a developer, I want Horizon to use shared epoch derivers with midway-fetch timing.",
      "acceptanceCriteria": [
        "Instantiate ProposerDutyDeriver with epoch-based iterator",
        "Instantiate BeaconBlobDeriver (fork-aware, Deneb+)",
        "Instantiate BeaconValidatorsDeriver",
        "Instantiate BeaconCommitteeDeriver",
        "Epoch derivers fetch for NEXT epoch midway through current epoch (configurable trigger %)",
        "All derivers use Horizon's ContextProvider",
        "Typecheck passes"
      ],
      "priority": 29,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-030",
      "title": "Add reorg handling",
      "description": "As a data collector, I want Horizon to handle chain reorgs gracefully.",
      "acceptanceCriteria": [
        "Subscribe to chain_reorg SSE events on each beacon node",
        "When reorg detected, mark affected slots for re-processing",
        "Configurable reorg depth limit (default: 64 slots)",
        "Derive events for new canonical blocks with reorg_detected metadata",
        "Metrics track reorg frequency and depth (xatu_horizon_reorgs_total)",
        "Typecheck passes"
      ],
      "priority": 30,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-031",
      "title": "Add Horizon configuration validation",
      "description": "As an operator, I want configuration validation on startup.",
      "acceptanceCriteria": [
        "Validate at least one beacon node URL is configured",
        "Validate coordinator address is configured",
        "Validate at least one output sink is configured",
        "Validate LAG distance is positive",
        "Validate TTL is positive duration",
        "Return clear error messages for invalid config",
        "Typecheck passes"
      ],
      "priority": 31,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-032",
      "title": "Create example_horizon.yaml configuration file",
      "description": "As an operator, I want an example configuration file.",
      "acceptanceCriteria": [
        "Create example_horizon.yaml at repository root",
        "Include documented configuration for multiple beacon nodes",
        "Include HEAD and FILL iterator configuration",
        "Include deduplication TTL configuration",
        "Include reorg depth configuration",
        "Include all deriver enable/disable options",
        "Include output sink configuration (xatu server)",
        "Typecheck passes"
      ],
      "priority": 32,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-033",
      "title": "Create Horizon documentation",
      "description": "As an operator, I want documentation for the Horizon module.",
      "acceptanceCriteria": [
        "Create docs/horizon.md with architecture overview",
        "Document dual-iterator design with diagram",
        "Document multi-beacon node connection",
        "Document HA deployment with coordinator",
        "Document comparison with Cannon (when to use which)",
        "Document all configuration options",
        "Document metrics reference"
      ],
      "priority": 33,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-034",
      "title": "Add Horizon to local docker-compose",
      "description": "As a developer, I want to test Horizon locally with docker-compose.",
      "acceptanceCriteria": [
        "Add horizon service to deploy/local/docker-compose.yml",
        "Horizon connects to local beacon node(s)",
        "Horizon sends events to local xatu-server",
        "xatu-server routes Horizon events to ClickHouse",
        "Add horizon config file to deploy/local/",
        "Typecheck passes"
      ],
      "priority": 34,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-035",
      "title": "Create Kurtosis E2E test configuration",
      "description": "As a developer, I want Kurtosis network config for E2E testing.",
      "acceptanceCriteria": [
        "Create deploy/kurtosis/horizon-test.yaml with ethereum-package config",
        "Include all consensus clients: Lighthouse, Prysm, Teku, Lodestar, Nimbus, Grandine",
        "Create Horizon config to connect to all CL beacon nodes",
        "Create xatu-server config for Kurtosis network",
        "Include ClickHouse setup in Kurtosis config"
      ],
      "priority": 35,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-036",
      "title": "Create Kurtosis E2E test script",
      "description": "As a developer, I want a test script to run the E2E test.",
      "acceptanceCriteria": [
        "Create scripts/e2e-horizon-test.sh",
        "Script spins up Kurtosis network + Xatu stack (coordinator, server, Horizon, ClickHouse)",
        "Script waits for network to produce blocks (~2 epochs / 13 minutes)",
        "Script runs validation queries against ClickHouse",
        "Script reports pass/fail status",
        "Document manual test procedure in README"
      ],
      "priority": 36,
      "passes": false,
      "notes": ""
    },
    {
      "id": "US-037",
      "title": "Create E2E validation queries",
      "description": "As a developer, I want validation queries to confirm Horizon is working.",
      "acceptanceCriteria": [
        "Create scripts/e2e-horizon-validate.sql with validation queries",
        "Query to count beacon blocks by slot (should be 1 per slot, no duplicates)",
        "Query to verify no gaps in slot sequence (FILL working)",
        "Query to verify events have module_name = HORIZON",
        "Query to count events per deriver type",
        "Document expected results in test README"
      ],
      "priority": 37,
      "passes": false,
      "notes": ""
    }
  ]
}
